
　AutoLuminous 上級編



※この文書では3DCG用語、DirectX用語、MME用語が
　説明なく登場しますがご了承ください。


■ AutoLuminous 基本構造

AutoLuminousの実態はHDR描画エンジンです。
色情報はすべて浮動小数点で扱われ、0〜1を超える範囲の色を
扱うことが可能です。そして、1を超える色は高輝度部分として
ブルームやグレアの処理が行われます。

AL_EmitterRT は意図的に高輝度部分を付加するための
フロントエンドに過ぎません。


■ キーカラー発光

KeyLuminousと同様、キーカラーを指定して任意の色に発光させることができます。
エフェクトを開き、以下の3つのパラメータを編集します。

・KeyThreshold
　色の判定に使われる閾値です。

・KEYCOLOR_NUM
　キーカラーの数です。
　0を指定するとキーカラー発光は無効になります。

・KeyColors
　キーカラーの配列です。
　コメント文に従って、キー色,コア色,発光色の3つを追加します。
　必ずKEYCOLOR_NUMで指定した数だけ設定する必要があります。
　ただしKEYCOLOR_NUMが0の場合はパラメータそのものが無視されるので
　どうなっていてもOKです。
　

■ 表情による個別発光制御

PMDまたはPMXモデルの場合、以下のような名前のダミー表情を
モデルに組み込むことで、モデル個別に発光を制御できます。
必要なものだけ選んでもかまいません。

・LightUp
・LightOff
・LightBlink
・LightBS
・LightUpE
・LightDuty
・LightMin
・LClockUp　　←New!
・LClockDown　←New!


"LightUp"および"LightOff"では光量を調整できます。
LightUpでは最大3倍まで明るくなります。
LightOffではMAXで完全に発光が消えます。

"LightBlink"および"LightBS"というダミー表情を使うと、
発光の点滅をモデル個別制御できます。
"LightBlink"はサイン波点滅、LightBSは矩形波点滅をします。
最大で10秒間隔になります。

"LightUpE"では、明るさが指数関数的に上昇します。
最大で400倍まで上昇します。

"LightDuty"は点滅のオンとオフの比率を変えることができます。
"LightMin"は点滅時の最小明るさを設定できます。

"LClockUp"は、後述の頂点発光機能による点滅、
および発光シーケンス制御の周期を早めます。
最大で6倍速です。
"LClockDown"は逆に点滅の周期を遅くします。最大で1/6倍速です。


これらダミー表情が使えるのはAL_Object.fxsubにより
スペキュラ強度または頂点発光機能を利用して発光指定した場合だけです。


Ver.4.0より、付属のALMorphMakerで
簡単にこれらモーフを追加できるようになりました。
OptionsのAutoLuminousSetterに同梱されています。



■ 頂点発光機能

PMXのみ、追加UVを用いて頂点ごとの発光制御を行うことができます。
材質指定より柔軟に設定できますが、改造やデータ管理は煩雑になります。

・追加UV1
　・X:0.2, Y:0.7
　　AutoLuminous用の追加UVデータであることを示す識別コードです。
　　この値は固定です。

　・Z:点滅周期
　　点滅周期を秒で指定します。
　　マイナスの値では矩形波点滅になります。

　・W:フラグ
　　フラグを指定します。以下のうち指定したい項目を加算します。
　　この値は、ある面に使われる全ての頂点において等しくなければなりません。

　　・1の桁：テクスチャモード
　　　・0 : 標準（テクスチャ乗算）
　　　・1 : テクスチャ乗算なし
　　　・2 : 高輝度抽出。UV2に(1,1,1,1)を指定するとAL_Textureと同等になります。
　　・10の桁：カラーモード
　　　・00 : 標準(RGB指定)
　　　・10 : UV2のXYZをRGBからHSVに変更します。
　　　

・追加UV2
　・X:赤, Y:緑, Z:青
　　発光色を指定します。

　・W:発光強度
　　発光強度を指定します。基準は1です。


・追加UV3
　・X:テクスチャ減色
　　テクスチャの色からこの値が減算されます。0以下になった場合は0に切り上げです。

　・Y:点滅位相
　　点滅の位相を秒で指定します。

　・Z:ポップアップ
　　指定した値の分だけ、発光部位を法線方向に押し出して描画します。
　　この機能を使用して発光用オブジェクトを隠すことができます。


　Optionsフォルダに、PMDEでの選択頂点の追加UVを一括変更するスクリプトを同梱します。
　プラグイン > CSSScript から読み込み、適当に値を書き換えて実行してください。

　また、Ver.3.1より、GUIで頂点発光を設定できるプラグイン「AutoLuminousSetter」が
　付属します。Optionsフォルダに圧縮された状態で入っていますので、
　解凍後PMDEのプラグインフォルダに入れて使用してください。
　Win7ではブロックの解除が必要です。


■ 発光シーケンス制御機能

通常スフィアテクスチャは、円形の部分しか使用されません。
このことを利用し、スフィアテクスチャの四隅に情報を書き込むことで、
発光を制御する機能です。

従来はサイン波点滅か矩形波点滅のどちらかの点滅をさせることしかできませんでしたが、
この機能により複雑な発光シーケンスであっても実現できるようになりました。

この機能は、スフィアの指定ができるならば
PMD、PMX、アクセサリ問わず使用できます。
また、すでにスフィアが設定されていても、そのスフィアの四隅に描き込めばOKです。

・指定方法

○シーケンスマップ
　スフィアマップの左上の、縦が1ピクセル、横が画像幅の1/4の領域が
　発光シーケンス指定部位になります。
　時間に応じて、色が左から右へ読み込まれ、発光色に乗算されます。
　画像幅の1/4まで達すると、また左端に戻ります。

○識別コード
　右下の1ピクセルは、発光シーケンス用スフィアであることを表す識別子です。
　色は(255,127,0)または(255,127,255)を設定します。
　右下が(255,127,0)のときはピクセル間の補間は行われず、デジタルな切り替えになります。
　(255,127,255)のときはピクセル間が線形補完され、なめらかな変化になります。

　意図しないスフィアが認識されてしまった場合は
　この部分を黒く塗りつぶしてください。

○周期
　左下は発光シーケンス周期を指定します。
　Rは分、Gは秒、Bは1/100秒が指定でき、これらを加算した値が周期になります。
　値は256諧調のときのものです。



・注意事項

発光シーケンス制御は乗算によるので、
光らせたい部位には材質発光または頂点発光があらかじめ設定されている必要があります。

スフィアマップには、JPEGなどの不可逆圧縮形式を使用しないでください。
すでにJPEGのスフィアが設定されている場合は、BMP、PNGなどに変換してください。



■ PMDEによるアクセサリ編集

・PMDEを起動して、編集したいXファイルをドラッグ＆ドロップします。
・「新規」「10倍」で読み込みます。
・材質などを編集します。
　MMDでアクセサリとして読み込んだ時と表示のされ方が違うので注意。
・メニューから「ファイル」→「エクスポート」を選び、名前を付けて保存します。
・サイズを「1/10倍」を選んで出力。
・PMDEを終了します。未保存の警告が出ますが無視してOKです。


■ マスク機能

特定のオブジェクトを発光の影響を受けないように設定できます。
まずは、エフェクトを開いて MASK_ENABLE オプションを1に設定します。
するとMMEの設定タブに"AL_MaskRT"が出現するので、
発光の影響を受けないようにしたいオブジェクトを選んで右クリックし
「解除」をクリックします。

発光しているオブジェクトにマスクを適用すると、
後光やオーラのような表現になります。


■ 残光機能

エフェクトを開き、AFTERGLOWを0以上の値にすると残光機能が有効になります。
フレームブレンド方式のため、あまり高速移動させると不連続になってしまいます。
出力FPSを上げるなどして対応してください。


■ テクスチャの異方性フィルタリング対応

複雑なテクスチャを適用した材質を光らせると、テクスチャの縮小の影響で
発光がチラつくことがあります。
AL_Object.fxsub の MIPMAPTEX_SIZE を変更すると
異方性フィルタリングが有効になり、チラつきを緩和できることがあります。
値はモデルに使用されているテクスチャの最大サイズと同じぐらいが推奨されますが、
大きすぎると重くなります。
また、全体的にぼやける副作用があります。

MMDx64およびMMMでは標準で異方性フィルタリング対応しているため、
この機能を使う必要はありません。


■ テクスチャ高輝度部分発光

発光させたい部分がテクスチャ上に描かれていて材質として分離できないとき、
MMEのAL_EmitterRTタブから目的のモデルまたは材質を選んで
付属のAL_Texture.fxを適用すると、テクスチャの明るいところだけ発光するように
設定できます。
ただし、細かい調整が必要なことが多いです。


■ トーンカーブ変更

ToneCurve.x を読み込むとAutoLuminousのトーンカーブが変更され、
白飛びを起こしにくくなります。
ただし元スクリーンのコントラストを落とすことになるので、
高輝度部分が画面上に多く存在する場合の使用を推奨します。

逆に画面が暗い場合、低輝度のトーンカーブは直線のままなので
コントラストを落とさず利用できます。

SCREEN_TONECURVEを1にすることでトーンカーブを強制オンにできます。


■ テストモード

AL_Test.xを読み込むとAutoLuminousはテストモードになり、
ぼかしを入れる前の高輝度部分のみを表示します。

AL_Test.xのSiで、明るさを操作できます。

AutoLuminousの発光描画では満足できない場合、
テストモード出力を動画編集ソフトで読み込んでグロー処理を行う方法があります。


■ 加算合成による高輝度付加

加算合成に設定したアクセサリやモデルによって色が1を超えた部分は
通常では1にクランプされるだけですが、AutoLuminousでは
レンダーターゲットの変更によりMMD側の描画であっても1を超える情報を
取り扱うことが可能で、高輝度部分として扱われるようになります。

ただし、加算合成でない通常の描画では、シェーダ内で値がクランプされる
ため、例えば照明を通常より明るくしたとしても高輝度部分は発生しません。
ただし加算スフィアだけは例外のようです。

シェーダを独自のものに置き換えた場合はこの限りではありません。


■ 光源エフェクトとの併用

MMDのスクリーン上に加算合成するタイプのエフェクトは、
HDR処理に対応させることができます。
例として、SpotLight、PanelLight、PostPointLightなどがあります。
通常、SpotLightで照らした場所が明るすぎるとその部分が白飛びするだけですが、
AutoLuminousより描画順を前にし、かつ間に他の(HDR未対応の)ポストエフェクトを
挟まないようにすると、高輝度部分として
ブルームやグレア効果を与えることができます。


■ サポートエフェクト「LightSampling」

LightSamplingは、画面の1を超える高輝度部分を抽出して
AutoLuminousに渡すエフェクトです。
HDR機能の自由度を高めます。
Siで高輝度部分の発光強度を、Trで高輝度部分とみなす閾値を指定できます。

以下のようなエフェクトの並び順を推奨しています。

・HDR対応ポストエフェクト、加算合成系のポストエフェクト（PanelLight、PointLightなど）
　　　↓
・LightSampling
　　　↓
・HDR未対応のポストエフェクト（Diffusion、SSAOなど）
　　　↓
・AutoLuminous
　　　↓
・ほかのポストエフェクトの影響を受けたくないポストエフェクト（字幕など）


■ 高画質を得るために

高画質を追求するのであれば、
サンプリング数を倍ぐらいに増やした上で、
なるべく大きいサイズで出力して縮小することをお勧めします。


■ MikuMikuMoving対応

AutoLuminousはまだ仮ではありますがMikuMikuMovingに対応しています。
MikuMikuMovingでは、AutoLuminous.xではなくAutoLuminous.fxを読み込むことで
エフェクトが有効になります。

まだ一部機能が使えなかったり、MMMの今後の更新の影響を受けることがありますので
ご了承ください。

